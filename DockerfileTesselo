FROM 595064993071.dkr.ecr.eu-west-1.amazonaws.com/tesselo-base:latest

# Add requirements files separately to be able to cache pip and npm installs.
ADD requirements/common.txt /code/requirements_common.txt
ADD requirements/workers.txt /code/requirements_workers.txt
RUN pip3 install -r /code/requirements_common.txt && pip3 install -r /code/requirements_workers.txt

ADD frontend/package.json /code/frontend/package.json
RUN npm install --prefix frontend frontend

ADD . /code/

# Build frontend.
RUN r.js -o frontend/js/build.js

# Make compress collect migrate script executable.
RUN chmod +x /code/compress_collect_migrate.sh
