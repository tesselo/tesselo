FROM tesselo-zappa

# Install ProductDownload
RUN curl -O -L https://github.com/kraftek/awsdownload/releases/download/1.7.2/ProductDownload-1.7.2.zip &&\
  unzip ProductDownload-1.7.2.zip -d / &&\
  rm ProductDownload-1.7.2.zip

# Install Sen2Cor
# http://step.esa.int/main/third-party-plugins-2/sen2cor/
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_ACCESS_KEY_ID
RUN aws s3 cp s3://sen2cor-source/Sen2Cor-2.4.0-Linux64.run . &&\
  chmod +x ./Sen2Cor-2.4.0-Linux64.run &&\
  ./Sen2Cor-2.4.0-Linux64.run --target /Sen2Cor-2.4.0-Linux64 &&\
  rm ./Sen2Cor-2.4.0-Linux64.run

# Hotfix for Sen2Cor. Replace t1c_split[10] with t1c_split[-1] on line 163.
# Example product failing without fix: S2B_MSIL1C_20180224T132229_N0206_R038_T23LKC_20180224T140415.SAFE
# Example product successful without fix: S2A_MSIL1C_20180105T103421_N0206_R108_T30NUM_20180105T123915.SAFE
RUN sed -i s/t1c_split[[]10[]]/t1c_split[-1]/g /Sen2Cor-2.4.0-Linux64/lib/python2.7/site-packages/sen2cor/L2A_Tables.py

# Install libraries for faster scipy and scikit-learn.
RUN rpm --rebuilddb && yum install -y blas-devel atlas-devel

# Install the worker dependencies
ADD requirements/workers.txt /code/requirements_workers.txt
RUN source /var/venv/bin/activate && \
  pip install -r /code/requirements_workers.txt
